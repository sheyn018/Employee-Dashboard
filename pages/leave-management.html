<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leave Management - HR Connect</title>
  <link rel="stylesheet" href="../css/leave-management.css"/>
  <link rel="stylesheet" href="../css/dashboard.css"/>
  <link rel="stylesheet" href="../components/navigation.css"/>
</head>
<body>
  <header><h1>Leave Management Dashboard</h1></header>

  <!-- Nav Component -->
  <div id="navigation-container"></div>

  <section class="management-section">
    <div class="container">
      <div class="dashboard-header">
        <div>
          <h2>üìã Leave Requests Overview</h2>
          <p>Review and manage employee leave requests</p>
        </div>
        <div class="header-stats">
          <div class="stat-card pending">
            <span class="stat-value" id="pendingCount">0</span>
            <span class="stat-label">Pending</span>
          </div>
          <div class="stat-card approved">
            <span class="stat-value" id="approvedCount">0</span>
            <span class="stat-label">Approved</span>
          </div>
          <div class="stat-card rejected">
            <span class="stat-value" id="rejectedCount">0</span>
            <span class="stat-label">Rejected</span>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-container">
        <div class="filter-group">
          <label for="statusFilter">Filter by Status:</label>
          <select id="statusFilter">
            <option value="all">All Requests</option>
            <option value="pending" selected>Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="searchEmployee">Search Employee:</label>
          <input type="text" id="searchEmployee" placeholder="Enter employee name...">
        </div>
        <div class="filter-group">
          <label for="dateFilter">Filter by Date:</label>
          <input type="date" id="dateFilter">
        </div>
        <button class="btn-refresh" onclick="loadLeaveRequests()">üîÑ Refresh</button>
      </div>

      <!-- Quick View Tabs -->
      <div class="tabs-container">
        <button class="tab-btn active" onclick="quickFilter('pending')">
          ‚è≥ Pending Requests
        </button>
        <button class="tab-btn" onclick="quickFilter('approved')">
          ‚úÖ Approved Requests
        </button>
        <button class="tab-btn" onclick="quickFilter('rejected')">
          ‚ùå Rejected Requests
        </button>
        <button class="tab-btn" onclick="quickFilter('all')">
          üìã All Requests
        </button>
      </div>

      <!-- Leave Requests Table -->
      <div class="table-container">
        <table class="leave-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Employee Name</th>
              <th>Leave Type</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Duration</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Requested On</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="leaveTableBody">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
        <div id="noDataMessage" class="no-data" style="display: none;">
          <div class="no-data-icon">üì≠</div>
          <p>No leave requests found</p>
        </div>
        <div id="loadingMessage" class="loading-message">
          <div class="spinner"></div>
          <p>Loading leave requests...</p>
        </div>
      </div>

      <!-- Action Confirmation Modal -->
      <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modalTitle">Confirm Action</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">
            <p id="modalMessage">Are you sure you want to perform this action?</p>
            <div class="employee-details" id="employeeDetails"></div>
          </div>
          <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" id="confirmBtn" onclick="confirmAction()">Confirm</button>
          </div>
        </div>
      </div>

      <!-- Success/Error Messages -->
      <div id="toast" class="toast" style="display: none;"></div>

    </div>
  </section>

  <!-- JavaScript -->
  <script src="../components/navigation.js"></script>
  <script>
    // Disable auto-initialization to customize the navigation
    window.NavigationComponent_AutoInit = false;
    
    // Check admin authentication
    const isAdmin = localStorage.getItem("isAdmin");
    if (isAdmin !== "true") {
      alert("Access denied. Admins only.");
      window.location.href = "admin-login.html";
    }

    // Initialize navigation
    NavigationComponent.init({
      containerId: 'navigation-container',
      menuType: 'admin',
      includeLogout: true,
      authCheck: false
    });

    NavigationComponent.setActiveNavItem('leave-management.html');

    // API Configuration
    const API_BASE = 'http://localhost:3000/api/api.php';
    
    // Global variables
    let allLeaveRequests = [];
    let currentAction = null;
    let currentRequestId = null;

    // Load leave requests on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadLeaveRequests();
      
      // Set up filter listeners
      document.getElementById('statusFilter').addEventListener('change', filterRequests);
      document.getElementById('searchEmployee').addEventListener('input', filterRequests);
      document.getElementById('dateFilter').addEventListener('change', filterRequests);
    });

    // Load all leave requests from API
    async function loadLeaveRequests() {
      const loadingMessage = document.getElementById('loadingMessage');
      const tableBody = document.getElementById('leaveTableBody');
      const noDataMessage = document.getElementById('noDataMessage');
      
      loadingMessage.style.display = 'block';
      noDataMessage.style.display = 'none';
      tableBody.innerHTML = '';

      try {
        const response = await fetch(`${API_BASE}/leave-requests`);
        const data = await response.json();

        console.log('=== API RESPONSE DEBUG ===');
        console.log('Full response:', data);
        console.log('Is array:', Array.isArray(data));
        if (Array.isArray(data) && data.length > 0) {
          console.log('First item:', data[0]);
          console.log('First item keys:', Object.keys(data[0]));
          console.log('ID field value:', data[0].id);
          console.log('ID field type:', typeof data[0].id);
        }
        console.log('========================');

        if (response.ok && Array.isArray(data)) {
          allLeaveRequests = data;
          updateStatistics();
          filterRequests();
        } else {
          throw new Error('Failed to load leave requests');
        }
      } catch (error) {
        console.error('Error loading leave requests:', error);
        showToast('Error loading leave requests', 'error');
        noDataMessage.querySelector('p').textContent = 'Error loading leave requests';
        noDataMessage.style.display = 'block';
      } finally {
        loadingMessage.style.display = 'none';
      }
    }

    // Update statistics cards
    function updateStatistics() {
      const pending = allLeaveRequests.filter(r => r.status === 'pending').length;
      const approved = allLeaveRequests.filter(r => r.status === 'approved').length;
      const rejected = allLeaveRequests.filter(r => r.status === 'rejected').length;

      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('rejectedCount').textContent = rejected;
    }

    // Quick filter function for tabs
    function quickFilter(status) {
      document.getElementById('statusFilter').value = status;
      
      // Update active tab
      const tabs = document.querySelectorAll('.tab-btn');
      tabs.forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      filterRequests();
    }

    // Filter and display requests
    function filterRequests() {
      const statusFilter = document.getElementById('statusFilter').value;
      const searchTerm = document.getElementById('searchEmployee').value.toLowerCase();
      const dateFilter = document.getElementById('dateFilter').value;
      
      let filtered = allLeaveRequests;

      // Filter by status
      if (statusFilter !== 'all') {
        filtered = filtered.filter(r => r.status === statusFilter);
      }

      // Filter by employee name
      if (searchTerm) {
        filtered = filtered.filter(r => 
          r.employee_name.toLowerCase().includes(searchTerm)
        );
      }

      // Filter by date
      if (dateFilter) {
        filtered = filtered.filter(r => {
          const startDate = new Date(r.start_date);
          const endDate = new Date(r.end_date);
          const filterDate = new Date(dateFilter);
          return filterDate >= startDate && filterDate <= endDate;
        });
      }

      displayRequests(filtered);
    }

    // Display requests in table
    function displayRequests(requests) {
      const tableBody = document.getElementById('leaveTableBody');
      const noDataMessage = document.getElementById('noDataMessage');

      if (requests.length === 0) {
        tableBody.innerHTML = '';
        noDataMessage.style.display = 'block';
        return;
      }

      noDataMessage.style.display = 'none';
      
      tableBody.innerHTML = requests.map((request, index) => {
        const duration = calculateDuration(request.start_date, request.end_date);
        const statusClass = `status-${request.status}`;
        const leaveTypeDisplay = formatLeaveType(request.leave_type);
        
        // Try multiple ways to get the ID
        const requestId = request.id || request.ID || request.leave_id || index;
        
        console.log(`Row ${index} - ID debug:`, {
          'request.id': request.id,
          'request.ID': request.ID,
          'typeof request.id': typeof request.id,
          'requestId used': requestId,
          'employee_name': request.employee_name
        });
        
        const escapedName = (request.employee_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        // Store the full request in a data attribute for retrieval
        const requestData = JSON.stringify(request).replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        
        return `
          <tr data-request-id="${requestId}" data-request='${requestData}'>
            <td>${requestId}</td>
            <td class="employee-name">${request.employee_name}</td>
            <td>${leaveTypeDisplay}</td>
            <td>${formatDate(request.start_date)}</td>
            <td>${formatDate(request.end_date)}</td>
            <td>${duration}</td>
            <td class="reason-cell" title="${request.reason || 'No reason provided'}">
              ${request.reason ? truncateText(request.reason, 50) : '<em>No reason</em>'}
            </td>
            <td><span class="status-badge ${statusClass}">${capitalizeFirst(request.status)}</span></td>
            <td>${formatDateTime(request.date_requested)}</td>
            <td class="actions-cell">
              ${request.status === 'pending' ? `
                <button class="btn-approve" onclick="handleActionClick(this, 'approve')" title="Approve">
                  ‚úì
                </button>
                <button class="btn-reject" onclick="handleActionClick(this, 'reject')" title="Reject">
                  ‚úó
                </button>
              ` : `
                <button class="btn-view" onclick="handleActionClick(this, 'view')" title="View Details">
                  üëÅÔ∏è
                </button>
              `}
              <button class="btn-delete" onclick="handleActionClick(this, 'delete')" title="Delete">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // New handler that gets ID from the row's data attribute
    function handleActionClick(button, action) {
      const row = button.closest('tr');
      const requestId = row.getAttribute('data-request-id');
      const requestDataStr = row.getAttribute('data-request');
      
      console.log('=== ACTION CLICK DEBUG ===');
      console.log('Action:', action);
      console.log('Request ID from row:', requestId);
      console.log('Request ID type:', typeof requestId);
      console.log('========================');
      
      let request;
      try {
        request = JSON.parse(requestDataStr.replace(/&#39;/g, "'").replace(/&quot;/g, '"'));
      } catch (e) {
        console.error('Failed to parse request data:', e);
        request = allLeaveRequests.find(r => String(r.id) === String(requestId) || String(r.ID) === String(requestId));
      }
      
      const employeeName = request ? request.employee_name : 'Unknown';
      
      if (action === 'view') {
        viewDetails(requestId);
      } else {
        showConfirmModal(action, requestId, employeeName);
      }
    }

    // Show confirmation modal
    function showConfirmModal(action, requestId, employeeName) {
      console.log('=== SHOW MODAL DEBUG ===');
      console.log('Action:', action);
      console.log('Request ID received:', requestId);
      console.log('Request ID type:', typeof requestId);
      console.log('Employee Name:', employeeName);
      
      currentAction = action;
      currentRequestId = requestId; // Keep as is, don't convert yet
      
      console.log('currentRequestId set to:', currentRequestId);
      
      const modal = document.getElementById('confirmModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      const confirmBtn = document.getElementById('confirmBtn');
      const employeeDetails = document.getElementById('employeeDetails');
      
      // Find the request details - try multiple comparison methods
      let request = allLeaveRequests.find(r => String(r.id) === String(requestId));
      if (!request) {
        request = allLeaveRequests.find(r => String(r.ID) === String(requestId));
      }
      if (!request) {
        request = allLeaveRequests.find(r => parseInt(r.id) === parseInt(requestId));
      }
      
      console.log('Found request:', request);
      console.log('======================');
      
      if (action === 'approve') {
        modalTitle.textContent = '‚úÖ Approve Leave Request';
        modalMessage.textContent = `Are you sure you want to approve this leave request?`;
        confirmBtn.className = 'btn-primary btn-approve';
        confirmBtn.textContent = 'Approve';
      } else if (action === 'reject') {
        modalTitle.textContent = '‚ùå Reject Leave Request';
        modalMessage.textContent = `Are you sure you want to reject this leave request?`;
        confirmBtn.className = 'btn-primary btn-reject';
        confirmBtn.textContent = 'Reject';
      } else if (action === 'delete') {
        modalTitle.textContent = 'üóëÔ∏è Delete Leave Request';
        modalMessage.textContent = `Are you sure you want to permanently delete this leave request?`;
        confirmBtn.className = 'btn-primary btn-delete';
        confirmBtn.textContent = 'Delete';
      }
      
      // Display employee details
      if (request) {
        employeeDetails.innerHTML = `
          <div class="detail-row"><strong>Employee:</strong> ${request.employee_name}</div>
          <div class="detail-row"><strong>Leave Type:</strong> ${formatLeaveType(request.leave_type)}</div>
          <div class="detail-row"><strong>Duration:</strong> ${formatDate(request.start_date)} to ${formatDate(request.end_date)}</div>
          <div class="detail-row"><strong>Reason:</strong> ${request.reason || 'No reason provided'}</div>
        `;
      }
      
      modal.style.display = 'flex';
    }

    // Close modal
    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
      currentAction = null;
      currentRequestId = null;
    }

    // Confirm and execute action
    async function confirmAction() {
      if (!currentAction || !currentRequestId) {
        console.error('Missing action or requestId:', { currentAction, currentRequestId });
        showToast('Error: Invalid request', 'error');
        return;
      }

      console.log('Confirming action:', currentAction, 'for request ID:', currentRequestId); // Debug log

      const confirmBtn = document.getElementById('confirmBtn');
      const originalText = confirmBtn.textContent;
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      try {
        if (currentAction === 'approve' || currentAction === 'reject') {
          await updateLeaveStatus(currentRequestId, currentAction === 'approve' ? 'approved' : 'rejected');
        } else if (currentAction === 'delete') {
          await deleteLeaveRequest(currentRequestId);
        }
        
        closeModal();
        await loadLeaveRequests();
        
        // Show appropriate success message based on action
        const actionMessages = {
          'approve': 'Leave request approved successfully',
          'reject': 'Leave request rejected',
          'delete': 'Leave request deleted'
        };
        showToast(actionMessages[currentAction] || 'Action completed successfully', 'success');
      } catch (error) {
        console.error(`Error ${currentAction}ing leave request:`, error);
        showToast(`Failed to ${currentAction} leave request: ${error.message}`, 'error');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
      }
    }

    // Update leave request status
    async function updateLeaveStatus(id, status) {
      const response = await fetch(`${API_BASE}/leave-requests`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id, status })
      });

      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Failed to update leave request');
      }
    }

    // Delete leave request
    async function deleteLeaveRequest(id) {
      const response = await fetch(`${API_BASE}/leave-requests`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id })
      });

      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Failed to delete leave request');
      }
    }

    // View request details (for already processed requests)
    function viewDetails(requestId) {
      const request = allLeaveRequests.find(r => parseInt(r.id) === parseInt(requestId));
      if (!request) return;

      const modal = document.getElementById('confirmModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      const confirmBtn = document.getElementById('confirmBtn');
      const employeeDetails = document.getElementById('employeeDetails');
      
      modalTitle.textContent = 'üìÑ Leave Request Details';
      modalMessage.textContent = '';
      confirmBtn.style.display = 'none';
      
      const statusEmoji = request.status === 'approved' ? '‚úÖ' : '‚ùå';
      
      employeeDetails.innerHTML = `
        <div class="detail-row"><strong>Request ID:</strong> ${request.id}</div>
        <div class="detail-row"><strong>Employee:</strong> ${request.employee_name}</div>
        <div class="detail-row"><strong>Leave Type:</strong> ${formatLeaveType(request.leave_type)}</div>
        <div class="detail-row"><strong>Start Date:</strong> ${formatDate(request.start_date)}</div>
        <div class="detail-row"><strong>End Date:</strong> ${formatDate(request.end_date)}</div>
        <div class="detail-row"><strong>Duration:</strong> ${calculateDuration(request.start_date, request.end_date)}</div>
        <div class="detail-row"><strong>Reason:</strong> ${request.reason || 'No reason provided'}</div>
        <div class="detail-row"><strong>Status:</strong> ${statusEmoji} ${capitalizeFirst(request.status)}</div>
        <div class="detail-row"><strong>Requested On:</strong> ${formatDateTime(request.date_requested)}</div>
        ${request.date_updated ? `<div class="detail-row"><strong>Last Updated:</strong> ${formatDateTime(request.date_updated)}</div>` : ''}
      `;
      
      modal.style.display = 'flex';
      
      // Restore confirm button when modal is closed
      modal.addEventListener('click', function restoreBtn(e) {
        if (e.target === modal || e.target.className === 'modal-close' || e.target.className.includes('btn-secondary')) {
          confirmBtn.style.display = 'inline-block';
          modal.removeEventListener('click', restoreBtn);
        }
      });
    }

    // Utility Functions
    function calculateDuration(startDate, endDate) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      return `${days} day${days !== 1 ? 's' : ''}`;
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatLeaveType(type) {
      const types = {
        'sick_leave': 'Sick Leave',
        'vacation_leave': 'Vacation Leave',
        'personal_leave': 'Personal Leave',
        'emergency_leave': 'Emergency Leave',
        'maternity_leave': 'Maternity Leave',
        'paternity_leave': 'Paternity Leave'
      };
      return types[type] || type;
    }

    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function truncateText(text, maxLength) {
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast toast-${type}`;
      toast.style.display = 'block';

      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('confirmModal');
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>
