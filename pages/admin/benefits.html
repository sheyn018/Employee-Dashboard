<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Benefits</title>
  <link rel="stylesheet" href="../../css/modules.css">
  <link rel="stylesheet" href="../../components/navigation.css">
</head>
<body>
  <!-- Navigation Component -->
  <div id="navigation-container"></div>
  
  <!-- Main Content -->
  <div class="container">
    <h2>üíº Employee Benefits</h2>
    <form id="benefitForm">
      <label>Employee ID <span style="color: red;">*</span></label>
      <input type="number" name="employee_id" id="employee_id" required min="10000" max="99999" placeholder="Enter 5-digit ID">
      <small id="employee_id_hint" style="color: #666; font-size: 11px;">Enter employee ID to auto-fill name</small>
      <small id="employee_id_error" style="color: #d32f2f; font-size: 11px; display: none;"></small>
      
      <label>Employee Name <span style="color: red;">*</span></label>
      <input type="text" id="employee_name_display" readonly style="background: #f5f5f5;" placeholder="Auto-filled">
      <small style="color: #666; font-size: 11px;">Auto-filled from Employee ID</small>
      
      <label>Benefit Type</label>
      <input type="text" name="benefit_type" required>
      <label>Description</label>
      <input type="text" name="description">
      <label>Amount</label>
      <input type="number" step="0.01" name="amount">
      <label>Start Date</label>
      <input type="date" name="start_date" required>
      <label>End Date</label>
      <input type="date" name="end_date">
      <button type="submit">Save Benefit</button>
    </form>

    <h3>Existing Benefits</h3>
    <table id="benefitsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Employee</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Duration</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Scripts -->
  <script>
    window.AdminNavigation_AutoInit = false;
  </script>
  <script src="../../components/navigation-admin.js"></script>
  <script>
    // Initialize navigation
    document.addEventListener('DOMContentLoaded', function() {
      AdminNavigation.init({
        containerId: 'navigation-container',
        includeLogout: true,
        authCheck: true
      });
      
      // Set active navigation item
      AdminNavigation.setActiveNavItem('benefits.html');
      
      // Load data
      loadData();
      
      // Employee ID lookup functionality
      setupEmployeeLookup();
    });

    const API_BASE = 'http://localhost:3000/api/api.php';
    let currentEmployeeName = '';

    function setupEmployeeLookup() {
      const employeeIdInput = document.getElementById('employee_id');
      const employeeNameDisplay = document.getElementById('employee_name_display');
      const employeeIdError = document.getElementById('employee_id_error');
      const employeeIdHint = document.getElementById('employee_id_hint');
      
      let lookupTimeout = null;
      
      employeeIdInput.addEventListener('input', function() {
        const employeeId = this.value.trim();
        
        // Clear previous timeout
        if (lookupTimeout) {
          clearTimeout(lookupTimeout);
        }
        
        // Reset fields if input is cleared
        if (!employeeId) {
          employeeNameDisplay.value = '';
          currentEmployeeName = '';
          employeeIdError.style.display = 'none';
          employeeIdHint.style.display = 'block';
          employeeIdHint.textContent = 'Enter employee ID to auto-fill name';
          employeeIdHint.style.color = '#666';
          return;
        }
        
        // Only lookup if it's a 5-digit number
        if (employeeId.length === 5 && /^\d{5}$/.test(employeeId)) {
          // Debounce lookup by 500ms
          lookupTimeout = setTimeout(() => {
            lookupEmployee(employeeId);
          }, 500);
        } else if (employeeId.length >= 5) {
          employeeIdError.textContent = 'Employee ID must be exactly 5 digits';
          employeeIdError.style.display = 'block';
          employeeIdHint.style.display = 'none';
          employeeNameDisplay.value = '';
          currentEmployeeName = '';
        }
      });
      
      async function lookupEmployee(employeeId) {
        try {
          employeeIdHint.textContent = 'Looking up employee...';
          employeeIdHint.style.color = '#1976d2';
          employeeIdError.style.display = 'none';
          
          const response = await fetch(`${API_BASE}/employee-lookup?id=${employeeId}`);
          const result = await response.json();
          
          if (response.ok && result.success && result.employee) {
            // Auto-fill employee name
            employeeNameDisplay.value = result.employee.name;
            currentEmployeeName = result.employee.name;
            
            // Show success message
            employeeIdHint.textContent = '‚úì Employee found';
            employeeIdHint.style.color = '#2e7d32';
            employeeIdError.style.display = 'none';
            
            // Reset hint after 2 seconds
            setTimeout(() => {
              employeeIdHint.textContent = 'Enter employee ID to auto-fill name';
              employeeIdHint.style.color = '#666';
            }, 2000);
          } else {
            // Employee not found
            employeeNameDisplay.value = '';
            currentEmployeeName = '';
            employeeIdError.textContent = result.error || 'Employee ID not found';
            employeeIdError.style.display = 'block';
            employeeIdHint.style.display = 'none';
          }
        } catch (error) {
          console.error('Error looking up employee:', error);
          employeeNameDisplay.value = '';
          currentEmployeeName = '';
          employeeIdError.textContent = 'Error connecting to server';
          employeeIdError.style.display = 'block';
          employeeIdHint.textContent = 'Enter employee ID to auto-fill name';
          employeeIdHint.style.color = '#666';
        }
      }
    }

    document.getElementById("benefitForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      // Validate employee name is populated
      if (!currentEmployeeName) {
        alert('Please enter a valid Employee ID first. Employee name must be auto-filled.');
        return;
      }
      
      try {
        const formData = new FormData(this);
        const response = await fetch("http://localhost:3000/api/api.php?action=add_benefit", { 
          method: "POST", 
          body: formData 
        });
        const data = await response.json();
        alert(data.message);
        this.reset();
        loadData();
      } catch (error) {
        console.error('Error submitting form:', error);
        alert('Error saving benefit record');
      }
    });

    async function loadData() {
      try {
        const response = await fetch("http://localhost:3000/api/api.php?action=get_benefits");
        const data = await response.json();
        const tbody = document.querySelector("#benefitsTable tbody");
        tbody.innerHTML = "";
        
        if (data.data && Array.isArray(data.data)) {
          data.data.forEach(row => {
            const duration = (row.start_date && row.end_date) 
              ? `${row.start_date} to ${row.end_date}` 
              : row.start_date || 'Not specified';
              
            tbody.innerHTML += `<tr>
              <td>${row.id || ''}</td>
              <td>${row.employee_name || ''}</td>
              <td>${row.benefit_type || ''}</td>
              <td>$${parseFloat(row.amount || 0).toFixed(2)}</td>
              <td>${duration}</td>
              <td>
                <button onclick="deleteBenefit(${row.id})" 
                        style="background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;"
                        title="Delete benefit">
                  üóëÔ∏è Delete
                </button>
              </td>
            </tr>`;
          });
        }
      } catch (error) {
        console.error('Error loading data:', error);
        const tbody = document.querySelector("#benefitsTable tbody");
        tbody.innerHTML = '<tr><td colspan="6">Error loading data</td></tr>';
      }
    }

    async function deleteBenefit(benefitId) {
      if (!confirm(`Are you sure you want to delete benefit record ID ${benefitId}? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch("http://localhost:3000/api/api.php/benefits", {
          method: "DELETE",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ id: benefitId })
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
          alert('Benefit record deleted successfully!');
          loadData(); // Reload the table
        } else {
          alert('Failed to delete benefit: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error deleting benefit:', error);
        alert('Error deleting benefit record');
      }
    }
  </script>
</body>
</html>





